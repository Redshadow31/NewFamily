// ==========================
// STAFF PAGE â€“ PÃ´les TENF
// ==========================

const clientId = "rr75kdousbzbp8qfjy0xtppwpljuke";
let token = "";

// Caches globaux accessibles partout (modale comprise)
let AVATARS = {};          // login (lowercase) -> url d'avatar
let LIVESET = new Set();   // logins en live

// ========== DonnÃ©es structurÃ©es par PÃ”LES ==========
const POLES = [
  {
    id: "red",
    emoji: "ðŸŸ¥",
    title: "Accueil & IntÃ©gration",
    desc: "Accueil des nouveaux, rÃ©unions dâ€™intÃ©gration, accompagnement et bonnes pratiques sur le serveur.",
    members: [
      {
        login: "red_shadow_31",
        name: "Red",
        level: "referent",
        // court texte sous la carte
        desc: "Coordination gÃ©nÃ©rale de lâ€™accueil, cadre et rituels dâ€™intÃ©gration.",
        // textes modale
        roleBio:
          "Fondateur de la New Family et garant du cadre bienveillant. Red veille Ã  la cohÃ©sion de la communautÃ© et accompagne les Ã©quipes. RÃ©fÃ©rent direct des pÃ´les Accueil & IntÃ©gration ainsi que Coordination & Formation interne.",
        personalBio:
          "Streamer multi-gaming, avec une grosse base Les Sims 4 (mode vie & constructions). Aussi des jeux de gestion et un rendez-vous communautaire hebdo (Fortnite) dans une ambiance chill, sans prise de tÃªte.",
        // rÃ©seaux
        twitch: "https://twitch.tv/red_shadow_31",
        instagram: "",
        tiktok: ""
      },
      {
        login: "tabs_up",
        name: "Tabâ€™s",
        level: "adjoint-ref",
        desc: "Adjoint rÃ©fÃ©rent â€” relais des intÃ©grations et organisation pratique.",
        roleBio:
          "Adjoint rÃ©fÃ©rent : coordination des intÃ©grations, suivi des tÃ¢ches et organisation.",
        personalBio: "",
        twitch: "https://twitch.tv/tabs_up",
        instagram: "",
        tiktok: ""
      },
      {
        login: "saikossama",
        name: "Saiko",
        level: "mentor",
        desc: "Mentor (tickets) â€” accueil des tickets et pÃ©dagogie.",
        roleBio:
          "Mentor : accueil des demandes (tickets), accompagnement et pÃ©dagogie.",
        personalBio: "",
        twitch: "https://twitch.tv/saikossama",
        instagram: "",
        tiktok: ""
      },
      {
        login: "gilbert_hime",
        name: "Gilbert",
        level: "mentor",
        desc: "Mentor â€” prÃ©sence et Ã©nergie sur le terrain.",
        roleBio: "Mentor terrain, soutien et Ã©nergie positive au quotidien.",
        personalBio: "",
        twitch: "https://twitch.tv/gilbert_hime",
        instagram: "",
        tiktok: ""
      },
      {
        login: "yaya_romali",
        name: "Yaya",
        level: "mentor",
        desc: "Mentor â€” dynamisme et bonne humeur.",
        roleBio: "Mentor : relais communication et Ã©nergie sur les lives.",
        personalBio: "",
        twitch: "https://twitch.tv/yaya_romali",
        instagram: "",
        tiktok: ""
      },
      {
        login: "rubbycrea",
        name: "Rubby",
        level: "mentor",
        desc: "Mentor â€” crÃ©ativitÃ© et soutien Ã  lâ€™intÃ©gration.",
        roleBio:
          "Mentor : idÃ©es crÃ©atives, animations et soutien aux intÃ©grations.",
        personalBio: "",
        twitch: "https://twitch.tv/rubbycrea",
        instagram: "",
        tiktok: ""
      },
      {
        login: "lespydyverse",
        name: "Spydy",
        level: "junior",
        desc: "Junior â€” apprentissage de la modÃ©ration et des rituels dâ€™accueil.",
        roleBio:
          "Junior : progression en modÃ©ration et participation aux rituels dâ€™accueil.",
        personalBio: "",
        twitch: "https://twitch.tv/lespydyverse",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "green",
    emoji: "ðŸ©·",
    title: "Planification, Animation & Ã‰vÃ©nements",
    desc: "Calendrier communautaire, animations et coordination inter-pÃ´les.",
    members: [
     {
  login: "clarastonewall",
  name: "Clara",
  level: "referent",
  // Sous-titre sur la carte
  desc: "RÃ©fÃ©rente â€” cheffe dâ€™orchestre des plannings & Ã©vÃ©nements.",
  // Bio rÃ´le TENF (modale)
  roleBio:
    "Fondatrice Ã©mÃ©rite de la New Family, Clara pilote le planning de A Ã  Z : rien ne se lance sans son feu vert. Elle conÃ§oit les agendas, valide, coordonne et participe Ã  chaque Ã©vÃ©nement. Planificatrice hors pair, elle gÃ¨re aussi la paperasse pour que tout roule, cÃ´tÃ© coulisses comme Ã  lâ€™Ã©cran.",
  // Bio de chaÃ®ne (modale)
  personalBio:
    "Joueuse invÃ©tÃ©rÃ©e des Sims 4 â€” attention, Ã§a peut vite prendre feuâ€¦ dans le jeu comme dans lâ€™ambiance ! ðŸ”¥ Viens pour un moment fun & chill sur Les Sims 4 et dâ€™autres jeux de simulation/gestion.",
  // RÃ©seaux
  twitch: "https://twitch.tv/clarastonewall",
  instagram: "",
  tiktok: ""
},

      {
        login: "jenny31200",
        name: "Jenny",
        level: "adjoint-ref",
        desc: "Adjointe rÃ©fÃ©rente â€” suivi des projets et rigueur logistique.",
        roleBio:
          "Adjointe rÃ©fÃ©rente : suivi des projets et logistique soignÃ©e.",
        personalBio: "",
        twitch: "https://twitch.tv/jenny31200",
        instagram: "",
        tiktok: ""
      },
      {
        login: "thedark_sand",
        name: "Dark",
        level: "mentor",
        desc: "Mentor â€” expÃ©rience, rÃ©tro & cartes (PokÃ©mon / Yu-Gi-Oh).",
        roleBio:
          "Mentor : expÃ©rience rÃ©tro & cartes (PokÃ©mon / Yu-Gi-Oh).",
        personalBio: "",
        twitch: "https://twitch.tv/thedark_sand",
        instagram: "",
        tiktok: ""
      },
      {
        login: "zylkao",
        name: "Zylkao",
        level: "junior",
        desc: "Junior â€” mise en place opÃ©rationnelle et soutien sur les events.",
        roleBio:
          "Junior : mise en place opÃ©rationnelle et soutien des Ã©vÃ©nements.",
        personalBio: "",
        twitch: "https://twitch.tv/zylkao",
        instagram: "",
        tiktok: ""
      },
      {
        login: "sigurdson64",
        name: "Sigur",
        level: "junior",
        desc: "Junior â€” relais du soutien des Ã©vÃ©nements.",
        roleBio: "Junior : relais et logistique sur les Ã©vÃ©nements.",
        personalBio: "",
        twitch: "https://twitch.tv/sigurdson64",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "blue",
    emoji: "ðŸŸ¦",
    title: "Communication & Visuels",
    desc: "IdentitÃ© visuelle, rÃ©seaux sociaux et supports graphiques des projets.",
    members: [
      {
        login: "nexou31",
        name: "Nexou",
        level: "referent",
        desc: "RÃ©fÃ©rent â€” identitÃ© visuelle, rÃ©seaux, ligne graphique.",
        roleBio:
          "RÃ©fÃ©rent com/visuels : identitÃ© visuelle, rÃ©seaux et ligne graphique.",
        personalBio: "",
        twitch: "https://twitch.tv/nexou31",
        instagram: "",
        tiktok: ""
      },
      {
        login: "selena_akemi",
        name: "Selena",
        level: "adjoint-ref",
        desc: "Adjointe rÃ©fÃ©rente â€” coordination crÃ©ative et diffusion.",
        roleBio:
          "Adjointe rÃ©fÃ©rente : coordination crÃ©ative et diffusion.",
        personalBio: "",
        twitch: "https://twitch.tv/selena_akemi",
        instagram: "",
        tiktok: ""
      },
      {
        login: "mmesigurdson64",
        name: "Mme Sigur",
        level: "support",
        desc: "Support visuel â€” aide sur les visuels & assets.",
        roleBio: "Support visuel : aide sur les visuels & assets.",
        personalBio: "",
        twitch: "https://twitch.tv/mmesigurdson64",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "yellow",
    emoji: "ðŸŸ¨",
    title: "Coordination & Formation interne",
    desc: "Organisation des process et formation des modÃ©rateurs.",
    members: [
      {
        login: "red_shadow_31",
        name: "Red",
        level: "referent",
        desc: "RÃ©fÃ©rent â€” process, standards et coordination des formations.",
        roleBio:
          "RÃ©fÃ©rent : process, standards et coordination de la formation interne.",
        personalBio: "",
        twitch: "https://twitch.tv/red_shadow_31",
        instagram: "",
        tiktok: ""
      },
      {
        login: "nangel89",
        name: "Nangel",
        level: "adjoint-ref",
        desc: "Adjoint rÃ©fÃ©rent â€” suivi Boost Live Team & accompagnement.",
        roleBio:
          "Adjoint rÃ©fÃ©rent : suivi Boost Live Team & accompagnement.",
        personalBio: "",
        twitch: "https://twitch.tv/nangel89",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "purple",
    emoji: "ðŸŸª",
    title: "Technique & Automatisation",
    desc: "Site, intÃ©grations, automatisations, outils internes et support technique.",
    members: [
      {
        login: "nexou31",
        name: "Nexou",
        level: "tech",
        desc: "Lead dev â€” rÃ©fÃ©rent technique pour arbitrages et dÃ©cisions.",
        roleBio:
          "Lead dev : intÃ©grations, automatisations et qualitÃ©.",
        personalBio: "",
        twitch: "https://twitch.tv/nexou31",
        instagram: "",
        tiktok: ""
      },
      {
        login: "red_shadow_31",
        name: "Red",
        level: "tech",
        desc: "Lead dev â€” rÃ©fÃ©rent technique pour le site.",
        roleBio:
          "Lead dev : rÃ©fÃ©rent technique pour le site.",
        personalBio: "",
        twitch: "https://twitch.tv/red_shadow_31",
        instagram: "",
        tiktok: ""
      }
    ]
  }
];

// ========== Utils ==========
const escapeHtml = (s) =>
  String(s)
    .replace(/&/g, "&amp;").replace(/</g, "&lt;")
    .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

function levelBadgeClass(level){
  switch(level){
    case "referent":    return "badge--referent";
    case "adjoint-ref": return "badge--adjoint-ref";
    case "mentor":      return "badge--mentor";
    case "junior":      return "badge--junior";
    case "support":     return "badge--support";
    case "tech":        return "badge--tech";
    default:            return "";
  }
}
function levelBadgeText(level){
  switch(level){
    case "referent":    return "RÃ©fÃ©rent";
    case "adjoint-ref": return "Adjoint rÃ©f.";
    case "mentor":      return "Mentor";
    case "junior":      return "Junior";
    case "support":     return "Support";
    case "tech":        return "Tech";
    default:            return "Staff";
  }
}

// ========== Token & Fetch ==========
async function getToken(){
  try{
    const res = await fetch("/.netlify/functions/getTwitchData");
    if(res.ok){
      const data = await res.json();
      token = data.access_token || "";
    }
  }catch(e){
    console.warn("Token Twitch indisponible:", e);
  }
}
async function getUsersByLogin(logins){
  if(!token) return {};
  const out = {};
  for(let i=0;i<logins.length;i+=90){
    const chunk = logins.slice(i,i+90);
    const query = chunk.map(l=>`login=${encodeURIComponent(l)}`).join("&");
    const url = `https://api.twitch.tv/helix/users?${query}`;
    const res = await fetch(url, {
      headers:{ "Client-ID": clientId, Authorization:"Bearer "+token }
    });
    if(res.ok){
      const json = await res.json();
      (json.data||[]).forEach(u=>{
        out[(u.login||"").toLowerCase()] = u.profile_image_url;
      });
    }
  }
  return out;
}
async function getLiveStatus(logins){
  if(!token) return new Set();
  const set = new Set();
  for(let i=0;i<logins.length;i+=100){
    const chunk = logins.slice(i,i+100);
    const query = chunk.map(l=>`user_login=${encodeURIComponent(l)}`).join("&");
    const url = `https://api.twitch.tv/helix/streams?${query}`;
    const res = await fetch(url, {
      headers:{ "Client-ID": clientId, Authorization:"Bearer "+token }
    });
    if(res.ok){
      const json = await res.json();
      (json.data||[]).forEach(s=> set.add((s.user_login||"").toLowerCase()));
    }
  }
  return set;
}

// ========== Rendu ==========
function renderPole(container, pole, avatarMap, liveSet, q=""){
  const section = document.createElement("section");
  section.className = `staff-section reveal pole-${pole.id}`;

  const h2 = document.createElement("h2");
  h2.textContent = `${pole.emoji} ${pole.title}`;
  section.appendChild(h2);

  if(pole.desc){
    const p = document.createElement("p");
    p.className = "pole-desc";
    p.textContent = pole.desc;
    section.appendChild(p);
  }

  const grid = document.createElement("div");
  grid.className = "staff-grid";

  pole.members
    .filter(m => {
      const s = q.trim().toLowerCase();
      if(!s) return true;
      return (
        m.name.toLowerCase().includes(s) ||
        m.login.toLowerCase().includes(s) ||
        (m.desc||"").toLowerCase().includes(s) ||
        (m.roleBio||"").toLowerCase().includes(s) ||
        (m.personalBio||"").toLowerCase().includes(s)
      );
    })
    .forEach(m => {
      const loginLc = m.login.toLowerCase();
      const imgSrc = avatarMap[loginLc] || "https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_600x600.png";
      const isLive = liveSet?.has(loginLc);

      const card = document.createElement("article");
      card.className = "staff-card";
      card.innerHTML = `
        <div class="avatar-box">
          ${isLive ? `<span class="live-dot">LIVE</span>` : ""}
          <img class="avatar" loading="lazy" decoding="async" src="${imgSrc}" alt="Avatar de ${escapeHtml(m.name)}">
          <span class="badge ${levelBadgeClass(m.level)}">${levelBadgeText(m.level)}</span>
        </div>
        <div class="body">
          <h3 class="name">${escapeHtml(m.name)}</h3>
          <p class="desc">${escapeHtml(m.desc || "")}</p>
          <div class="btns" style="margin-top:.4rem;display:flex;gap:.4rem;justify-content:center">
            <a class="about-button" href="https://twitch.tv/${loginLc}" target="_blank" rel="noopener">Twitch</a>
            <button class="about-button" data-more="${loginLc}" data-level="${m.level}">Plus</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

  section.appendChild(grid);
  container.appendChild(section);
}

function showSkeletons(){
  const root = document.getElementById("staff-root");
  root.innerHTML = "";
  const sk = document.createElement("section");
  sk.className = "staff-section";
  const grid = document.createElement("div");
  grid.className = "staff-grid";
  for (let i=0;i<8;i++){
    const card = document.createElement("div");
    card.className = "skel";
    card.innerHTML = `<div class="ph big"></div><div class="ph" style="width:60%;margin:.4rem auto"></div><div class="ph" style="width:80%;margin:.3rem auto"></div>`;
    grid.appendChild(card);
  }
  sk.appendChild(grid);
  root.appendChild(sk);
}
function setupReveal(){
  const els = document.querySelectorAll('.reveal');
  if(!els.length) return;
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('in'); io.unobserve(e.target); } });
  },{threshold:.15});
  els.forEach(el=>io.observe(el));
}

// ========== INIT ==========
async function initStaff(){
  showSkeletons();
  await getToken();

  const root = document.getElementById("staff-root");
  const allLogins = POLES.flatMap(p => p.members.map(m => m.login.toLowerCase()));

  // RÃ©cup avatars + live, puis expose en global
  const [avatars, liveSet] = await Promise.all([
    getUsersByLogin(allLogins),
    getLiveStatus(allLogins)
  ]);
  AVATARS = avatars;
  LIVESET = liveSet;

  let activePole = "all";
  let query = "";

  function renderAll(){
    root.innerHTML = "";
    const groups = activePole === "all" ? POLES : POLES.filter(p => p.id === activePole);
    groups.forEach(pole => renderPole(root, pole, avatars, liveSet, query));
    setupReveal();
  }
  renderAll();

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("is-active"));
      t.classList.add("is-active");
      activePole = t.dataset.pole || "all";
      renderAll();
    });
  });

  // Recherche
  const input = document.getElementById("staff-search");
  if(input){
    input.addEventListener("input", ()=>{
      query = input.value.trim();
      renderAll();
    });
  }
}

document.addEventListener("DOMContentLoaded", initStaff);

// ========== MODALE (unique listener global) ==========
const modal = document.getElementById("staff-modal");
if (modal) {
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-more]");
    if (!btn) return;

    const login = (btn.getAttribute("data-more") || "").toLowerCase();
    const level = btn.getAttribute("data-level");
    const member = POLES.flatMap(p=>p.members).find(m=>m.login.toLowerCase()===login);
    if(!member) return;

    // Avatar depuis le cache global
    const avatarSrc =
      AVATARS[login] ||
      "https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_600x600.png";

    // Bios
    const roleBio     = (member.roleBio || member.desc || "").trim();
    const personalBio = (member.personalBio || member.bio || "").trim();

    // RÃ©seaux
    const tw = (member.twitch    || `https://twitch.tv/${login}`).trim();
    const ig = (member.instagram || "").trim();
    const tk = (member.tiktok    || "").trim();

    // Remplissage UI
    const $ = (id)=>document.getElementById(id);
    $("m-avatar").src = avatarSrc;
    $("m-avatar").alt = `Avatar de ${member.name}`;
    $("m-name").textContent = member.name;
    $("m-role").textContent = levelBadgeText(level);

    // RÃ´le TENF
    if (roleBio) {
      $("m-desc-role").textContent = roleBio;
      $("m-desc-role-wrap").hidden = false;
    } else {
      $("m-desc-role").textContent = "";
      $("m-desc-role-wrap").hidden = true;
    }

    // Bio de chaÃ®ne
    if (personalBio) {
      $("m-desc-personal").textContent = personalBio;
      $("m-desc-personal-wrap").hidden = false;
    } else {
      $("m-desc-personal").textContent = "";
      $("m-desc-personal-wrap").hidden = true;
    }

    // IcÃ´nes sociaux (affichage conditionnel)
    const links = [];
    if (tw) links.push(`<a href="${tw}" target="_blank" rel="noopener" aria-label="Twitch"><img src="assets/twitch.png" alt=""></a>`);
    if (ig) links.push(`<a href="${ig}" target="_blank" rel="noopener" aria-label="Instagram"><img src="assets/instagram.png" alt=""></a>`);
    if (tk) links.push(`<a href="${tk}" target="_blank" rel="noopener" aria-label="TikTok"><img src="assets/tiktok.png" alt=""></a>`);
    $("m-links").innerHTML = links.join("");

    modal.setAttribute("aria-hidden", "false");
  });

  document.getElementById("staff-close")?.addEventListener("click", () => modal.setAttribute("aria-hidden","true"));
  modal.addEventListener("click", (e) => { if (e.target.id === "staff-modal") modal.setAttribute("aria-hidden","true"); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") modal.setAttribute("aria-hidden","true"); });
}
