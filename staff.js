/* ======================================================
   üåà New Family ‚Äì Staff JS modernis√© 2025 (Glass Fade)
   ====================================================== */

const clientId = "rr75kdousbzbp8qfjy0xtppwpljuke";
let token = "";

/* ========= Donn√©es par p√¥les ========= */
// ========== Donn√©es structur√©es par P√îLES ==========
const POLES = [
  {
    id: "red",
    emoji: "üü•",
    title: "Accueil & Int√©gration",
    desc: "Accueil des nouveaux, r√©unions d‚Äôint√©gration, accompagnement et bonnes pratiques sur le serveur.",
    members: [
      {
  login: "red_shadow_31",
  name: "Red",
  level: "referent",

  // Texte court sur la carte
  desc: "Fondateur de la New Family, pilier du cadre bienveillant et r√©f√©rent des p√¥les Accueil & Formation.",

  // Bloc ‚ÄúR√¥le au sein de TENF‚Äù
  roleBio:
    "Fondateur de la New Family et garant du cadre bienveillant. Red veille √† la coh√©sion de la communaut√© et accompagne les √©quipes au quotidien. R√©f√©rent direct des p√¥les Accueil & Int√©gration ainsi que Coordination & Formation interne.",

  // Bloc ‚ÄúBio de cha√Æne‚Äù
  personalBio:
    "Streamer multi-gaming, passionn√© par Les Sims 4 ‚Äî que ce soit en mode vie ou en architecture. Red partage aussi des jeux de gestion et des sessions communautaires (Fortnite, jeux funs) dans une ambiance chill et sans prise de t√™te.",

  twitch: "https://twitch.tv/red_shadow_31",
  instagram: "",
  tiktok: "https://www.tiktok.com/@re_shadow_3143"
},

      {
        login: "tabs_up",
        name: "Tab‚Äôs",
        level: "adjoint-ref",
        desc: "Adjoint r√©f√©rent ‚Äî relais des int√©grations et organisation pratique.",
        bio: "Bras droit du p√¥le : fluidifie l‚Äôorganisation et assure la continuit√© quand les fondateurs ne sont pas dispo.",
        twitch: "https://twitch.tv/tabs_up",
        instagram: "",
        tiktok: ""
      },
      {
        login: "saikossama",
        name: "Saiko",
        level: "mentor",
        desc: "Mentor (tickets) ‚Äî accueil des tickets et p√©dagogie.",
        bio: "Point d‚Äôentr√©e sur les tickets : calme, p√©dagogue, accompagne les membres dans les cas sensibles.",
        twitch: "https://twitch.tv/saikossama",
        instagram: "",
        tiktok: ""
      },
      {
        login: "gilbert_hime",
        name: "Gilbert",
        level: "mentor",
        desc: "Mentor ‚Äî pr√©sence et √©nergie sur le terrain.",
        bio: "Mentore pr√©sente sur le terrain : bienveillance, s√©curit√© et √©nergie communicative.",
        twitch: "https://twitch.tv/gilbert_hime",
        instagram: "",
        tiktok: ""
      },
      {
        login: "yaya_romali",
        name: "Yaya",
        level: "mentor",
        desc: "Mentor ‚Äî dynamisme et bonne humeur.",
        bio: "Relais accueil & ambiance : dynamise les premiers pas et rassure les nouveaux.",
        twitch: "https://twitch.tv/yaya_romali",
        instagram: "",
        tiktok: ""
      },
      {
        login: "rubbycrea",
        name: "Rubby",
        level: "mentor",
        desc: "Mentor ‚Äî cr√©ativit√© et soutien √† l‚Äôint√©gration.",
        bio: "Apporte une touche cr√©ative et des id√©es concr√®tes pour rendre l‚Äôint√©gration agr√©able et claire.",
        twitch: "https://twitch.tv/rubbycrea",
        instagram: "",
        tiktok: ""
      },
      {
        login: "lespydyverse",
        name: "Spydy",
        level: "junior",
        desc: "Junior ‚Äî apprentissage de la mod√©ration et des rituels d‚Äôaccueil.",
        bio: "En formation : met en pratique les rituels d‚Äôaccueil et gagne en autonomie √† chaque session.",
        twitch: "https://twitch.tv/lespydyverse",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "green",
    emoji: "ü©∑",
    title: "Planification, Animation & √âv√©nements",
    desc: "Calendrier des √©v√©nements communautaires, animations, soir√©es sp√©ciales et coordination inter-p√¥les.",
    members: [
      {
        login: "clarastonewall",
        name: "Clara",
        level: "referent",
        desc: "R√©f√©rente ‚Äî planification, organisation et animation des √©v√©nements.",
        bio: "Chef d‚Äôorchestre des events : structure, anime et veille √† l‚Äôinclusion de tous les membres.",
        twitch: "https://twitch.tv/clarastonewall",
        instagram: "",
        tiktok: ""
      },
      {
        login: "jenny31200",
        name: "Jenny",
        level: "adjoint-ref",
        desc: "Adjointe r√©f√©rente ‚Äî suivi des projets et rigueur logistique.",
        bio: "Main s√ªre du p√¥le : rigueur logistique, suivi des plannings et coordination fine des √©quipes.",
        twitch: "https://twitch.tv/jenny31200",
        instagram: "",
        tiktok: ""
      },
      {
        login: "rubbycrea",
        name: "Rubby",
        level: "mentor",
        desc: "Mentor ‚Äî soutien animation & id√©es cr√©atives.",
        bio: "Apporte id√©es et formats originaux, booste l‚Äôengagement lors des soir√©es sp√©ciales.",
        twitch: "https://twitch.tv/rubbycrea",
        instagram: "",
        tiktok: ""
      },
      {
        login: "thedark_sand",
        name: "Dark",
        level: "mentor",
        desc: "Mentor ‚Äî exp√©rience, r√©tro & cartes (Pok√©mon / Yu-Gi-Oh).",
        bio: "R√©f√©rent r√©tro & cartes : expertise jeux de cartes, culture √©v√©nementielle et vibes old school.",
        twitch: "https://twitch.tv/thedark_sand",
        instagram: "",
        tiktok: ""
      },
      {
        login: "zylkao",
        name: "Zylkao",
        level: "junior",
        desc: "Junior ‚Äî mise en place op√©rationnelle et soutien sur les events.",
        bio: "Aide op√©rationnelle : pr√©paration technique, relais chat et mise en place des activit√©s.",
        twitch: "https://twitch.tv/zylkao",
        instagram: "",
        tiktok: ""
      },
      {
        login: "sigurdson64",
        name: "Sigur",
        level: "junior",
        desc: "Junior ‚Äî relais du soutien des √©v√©nements.",
        bio: "Support terrain : aide √† la logistique live et au bon d√©roul√© des animations.",
        twitch: "https://twitch.tv/sigurdson64",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "blue",
    emoji: "üü¶",
    title: "Communication & Visuels",
    desc: "Identit√© visuelle, r√©seaux sociaux, supports graphiques des projets et valorisation des membres.",
    members: [
      {
        login: "nexou31",
        name: "Nexou",
        level: "referent",
        desc: "R√©f√©rent ‚Äî identit√© visuelle, r√©seaux, ligne graphique.",
        bio: "Pilote de l‚Äôidentit√© visuelle : coh√©rence, templates et habillages pour une image forte.",
        twitch: "https://twitch.tv/nexou31",
        instagram: "https://www.instagram.com/nexou_31",
        tiktok: "https://www.tiktok.com/@nexou31"
      },
      {
        login: "selena_akemi",
        name: "Selena",
        level: "adjoint-ref",
        desc: "Adjointe r√©f√©rente ‚Äî coordination cr√©ative et diffusion.",
        bio: "Coordonne la prod‚Äô visuelle, harmonise les posts et assure une diffusion r√©guli√®re.",
        twitch: "https://twitch.tv/selena_akemi",
        instagram: "",
        tiktok: ""
      },
      {
        login: "yaya_romali",
        name: "Yaya",
        level: "mentor",
        desc: "Mentor ‚Äî relais communication et √©nergie sur les lives.",
        bio: "Relais social : booste la visibilit√© des cr√©ateurs et anime la pr√©sence sur les r√©seaux.",
        twitch: "https://twitch.tv/yaya_romali",
        instagram: "",
        tiktok: ""
      },
      {
        login: "mmesigurdson64",
        name: "Mme Sigur",
        level: "support",
        desc: "Support visuel ‚Äî aide sur les visuels & assets.",
        bio: "Soutien graphique : retouches simples, exports, petites aides visuelles au quotidien.",
        twitch: "",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "yellow",
    emoji: "üü®",
    title: "Coordination & Formation interne",
    desc: "Organisation des process, passation d‚Äôinformations, formation des mod√©rateurs et transmission des savoir-faire.",
    members: [
      {
        login: "red_shadow_31",
        name: "Red",
        level: "referent",
        desc: "R√©f√©rent ‚Äî process, standards et coordination des formations.",
        bio: "Structure les process, d√©finit les standards et anime les ateliers de formation.",
        twitch: "https://twitch.tv/red_shadow_31",
        instagram: "",
        tiktok: ""
      },
      {
        login: "nangel89",
        name: "Nangel",
        level: "adjoint-ref",
        desc: "Adjoint r√©f√©rent ‚Äî suivi des Boost Live Team & accompagnement.",
        bio: "Suivi de la Boost Live Team : mentoring de groupe, feedbacks et coaching pratique.",
        twitch: "https://twitch.tv/nangel89",
        instagram: "",
        tiktok: ""
      },
      {
        login: "yaya_romali",
        name: "Yaya",
        level: "mentor",
        desc: "Mentor ‚Äî entraide, posture et bonnes pratiques live.",
        bio: "Transmet les bonnes pratiques live : posture, accueil et gestion des situations.",
        twitch: "https://twitch.tv/yaya_romali",
        instagram: "",
        tiktok: ""
      },
      {
        login: "sigurdson64",
        name: "Sigur",
        level: "junior",
        desc: "Junior ‚Äî progression continue et participation aux ateliers.",
        bio: "En mont√©e en comp√©tences : applique les process et participe aux ateliers.",
        twitch: "https://twitch.tv/sigurdson64",
        instagram: "",
        tiktok: ""
      }
    ]
  },

  {
    id: "purple",
    emoji: "üü™",
    title: "Technique & Automatisation",
    desc: "Site, int√©grations, automatisations, outils internes et support technique aux membres.",
    members: [
      {
        login: "nexou31",
        name: "Nexou",
        level: "referent",
        desc: "R√©f√©rent technique ‚Äî int√©grations, automatisations et qualit√©.",
        bio: "Lead technique : int√®gre les outils, automatise et veille √† la qualit√© globale.",
        twitch: "https://twitch.tv/nexou31",
        instagram: "https://www.instagram.com/nexou_31",
        tiktok: "https://www.tiktok.com/@nexou31"
      },
      {
        login: "nangel89",
        name: "Nangel",
        level: "adjoint-ref",
        desc: "Adjoint en soutien ‚Äî aide technique et exploitation outils.",
        bio: "Support technique : tests, mises √† jour, aide √† l‚Äôexploitation des outils.",
        twitch: "https://twitch.tv/nangel89",
        instagram: "",
        tiktok: ""
      },
      {
        login: "nexou31",
        name: "Nexou",
        level: "tech",
        desc: "Lead dev ‚Äî r√©f√©rent technique pour arbitrages et d√©cisions.",
        bio: "Garant technique : tranchage des choix techniques, CI/CD et qualit√© du code.",
        twitch: "https://twitch.tv/nexou31",
        instagram: "https://www.instagram.com/nexou_31",
        tiktok: "https://www.tiktok.com/@nexou31"
      },
      {
        login: "red_shadow_31",
        name: "Red",
        level: "tech",
        desc: "Lead dev ‚Äî r√©f√©rent technique pour ce site.",
        bio: "Dev Web : front, int√©gration et suivi des fonctionnalit√©s du site TENF.",
        twitch: "https://twitch.tv/red_shadow_31",
        instagram: "",
        tiktok: ""
      }
    ]
  }
];


/* ========= Outils internes ========= */
const escapeHtml = s => String(s)
  .replace(/&/g,"&amp;")
  .replace(/</g,"&lt;")
  .replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;")
  .replace(/'/g,"&#039;");

function levelBadgeText(level){
  const map = {
    "referent":"R√©f√©rent",
    "adjoint-ref":"Adjoint r√©f.",
    "mentor":"Mentor",
    "junior":"Junior",
    "support":"Support",
    "tech":"Tech"
  };
  return map[level] || "Staff";
}

/* ========= Rendu Staff ========= */
async function getToken(){
  try {
    const res = await fetch("/.netlify/functions/getTwitchData");
    if(res.ok){ const data = await res.json(); token = data.access_token || ""; }
  } catch(e){ console.warn("Token Twitch non r√©cup√©r√©", e); }
}

async function getUsersByLogin(logins){
  if(!token) return {};
  const map = {};
  const res = await fetch(`https://api.twitch.tv/helix/users?${logins.map(l=>`login=${l}`).join("&")}`,
    { headers:{ "Client-ID": clientId, Authorization:"Bearer "+token } });
  if(res.ok){
    const json = await res.json();
    (json.data||[]).forEach(u=>{
      map[u.login.toLowerCase()] = u.profile_image_url;
    });
  }
  return map;
}

function renderPole(container, pole, avatars){
  const section = document.createElement("section");
  section.className = "staff-section";
  section.innerHTML = `
    <h2>${pole.emoji} ${pole.title}</h2>
    <p>${pole.desc}</p>
    <div class="staff-grid"></div>`;
  const grid = section.querySelector(".staff-grid");

  pole.members.forEach(m=>{
    const login = m.login.toLowerCase();
    const imgSrc = avatars?.[login] || "https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_600x600.png";

    const card = document.createElement("article");
    card.className = "staff-card";
    card.innerHTML = `
      <div class="avatar-box">
        <img class="avatar" src="${imgSrc}" alt="${escapeHtml(m.name)}">
        <span class="badge badge--${m.level}">${levelBadgeText(m.level)}</span>
      </div>
      <div class="body">
        <h3 class="name">${escapeHtml(m.name)}</h3>
        <p class="desc">${escapeHtml(m.desc)}</p>
        <div class="btns">
          <a href="${m.twitch}" target="_blank" rel="noopener" class="about-button">Twitch</a>
          <button class="about-button" data-more="${login}">Plus</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });

  container.appendChild(section);
}

// --- OUVERTURE MODALE : bouton "Plus"
const modal = document.getElementById("staff-modal");
if (modal) {
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-more]");
    if (!btn) return;

    const login = btn.getAttribute("data-more");
    const level = btn.getAttribute("data-level");
    const member = POLES.flatMap(p => p.members).find(m => m.login.toLowerCase() === login);
    if (!member) return;

    // R√©cup avatar
    const avatarSrc = (window.__avatarMap?.[login]) ||
                      "https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_600x600.png";

    // Champs bio
    const roleBio      = (member.roleBio || member.desc || "").trim();
    const personalBio  = (member.personalBio || member.bio || "").trim();

    // R√©seaux
    const tw = (member.twitch    || `https://twitch.tv/${login}`).trim();
    const ig = (member.instagram || "").trim();
    const tk = (member.tiktok    || "").trim();

    // Remplissage
    document.getElementById("m-avatar").src = avatarSrc;
    document.getElementById("m-avatar").alt = `Avatar de ${member.name}`;
    document.getElementById("m-name").textContent = member.name;
    document.getElementById("m-role").textContent = levelBadgeText(level);

    // Sections bio
    const roleWrap = document.getElementById("m-desc-role-wrap");
    const roleEl   = document.getElementById("m-desc-role");
    const persWrap = document.getElementById("m-desc-personal-wrap");
    const persEl   = document.getElementById("m-desc-personal");

    if (roleBio) {
      roleEl.textContent = roleBio;
      roleWrap.hidden = false;
    } else {
      roleWrap.hidden = true;
      roleEl.textContent = "";
    }

    if (personalBio) {
      persEl.textContent = personalBio;
      persWrap.hidden = false;
    } else {
      persWrap.hidden = true;
      persEl.textContent = "";
    }

    // Liens r√©seaux
    const links = [];
    if (tw) links.push(`<a href="${tw}" target="_blank" rel="noopener"><img src="assets/twitch.png" alt="Twitch"></a>`);
    if (ig) links.push(`<a href="${ig}" target="_blank" rel="noopener"><img src="assets/instagram.png" alt="Instagram"></a>`);
    if (tk) links.push(`<a href="${tk}" target="_blank" rel="noopener"><img src="assets/tiktok.png" alt="TikTok"></a>`);
    document.getElementById("m-links").innerHTML = links.join("");

    modal.setAttribute("aria-hidden", "false");
  });

  document.getElementById("staff-close")?.addEventListener("click", () => modal.setAttribute("aria-hidden","true"));
  modal.addEventListener("click", (e) => { if (e.target.id === "staff-modal") modal.setAttribute("aria-hidden","true"); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") modal.setAttribute("aria-hidden","true"); });
}

/* ========= Initialisation ========= */
async function initStaff(){
  const root = document.getElementById("staff-root");
  await getToken();
  const allLogins = POLES.flatMap(p=>p.members.map(m=>m.login.toLowerCase()));
  const avatars = await getUsersByLogin(allLogins);
  POLES.forEach(pole => renderPole(root, pole, avatars));

  document.addEventListener("click", e=>{
    const btn = e.target.closest("[data-more]");
    if(!btn) return;
    const login = btn.getAttribute("data-more");
    const member = POLES.flatMap(p=>p.members).find(m=>m.login.toLowerCase()===login);
    if(!member) return;
    const avatar = avatars?.[login] || "https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_600x600.png";
    openModal(member, avatar);
  });
}
document.addEventListener("DOMContentLoaded", initStaff);
